name: Auto Deploy n8n

on:
  push:
    branches: [ master ]
    paths:
      - 'docker-compose.yml'
      - 'docker-compose.override.yml'
      - 'cloudflared-config/**'
      - 'workflows/**'
      - '.github/workflows/**'
  workflow_dispatch:
    # Cho phÃ©p kÃ­ch hoáº¡t thá»§ cÃ´ng

jobs:
  deploy:
    runs-on: self-hosted  # Chá»‰ Ä‘á»‹nh sá»­ dá»¥ng self-hosted runner thay vÃ¬ ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Create .env file from secrets
        run: |
          echo "Creating .env file..."
          
          # LuÃ´n sá»­ dá»¥ng khÃ³a mÃ£ hÃ³a tá»« GitHub Secrets
          N8N_ENCRYPTION_KEY_VALUE="${{ secrets.N8N_ENCRYPTION_KEY }}"
          echo "ðŸ”‘ Sá»­ dá»¥ng khÃ³a mÃ£ hÃ³a tá»« GitHub Secrets"
          echo "$N8N_ENCRYPTION_KEY_VALUE"
          
          # Táº¡o file .env tá»« GitHub Secrets vÃ  Variables
          cat > .env << EOF
          # PostgreSQL
          POSTGRES_USER=${{ secrets.POSTGRES_USER || 'n8n' }}
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB=${{ secrets.POSTGRES_DB || 'n8n_database' }}
          
          # n8n
          N8N_BASIC_AUTH_USER=${{ secrets.N8N_BASIC_AUTH_USER || 'admin' }}
          N8N_BASIC_AUTH_PASSWORD=${{ secrets.N8N_BASIC_AUTH_PASSWORD }}
          N8N_ENCRYPTION_KEY=$N8N_ENCRYPTION_KEY_VALUE
          DB_POSTGRESDB_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          WEBHOOK_URL=${{ vars.WEBHOOK_URL }}
          
          # Timezone & other settings
          GENERIC_TIMEZONE=${{ secrets.GENERIC_TIMEZONE || 'Asia/Ho_Chi_Minh' }}
          TZ=${{ secrets.TZ || 'Asia/Ho_Chi_Minh' }}
          N8N_DEFAULT_BINARY_DATA_MODE=${{ secrets.N8N_DEFAULT_BINARY_DATA_MODE || 'filesystem' }}
          EXECUTIONS_DATA_PRUNE=${{ secrets.EXECUTIONS_DATA_PRUNE || 'true' }}
          EXECUTIONS_DATA_MAX_AGE=${{ secrets.EXECUTIONS_DATA_MAX_AGE || '720' }}
          EXECUTIONS_DATA_PRUNE_MAX_COUNT=${{ secrets.EXECUTIONS_DATA_PRUNE_MAX_COUNT || '50000' }}
          
          # Cloudflare Tunnel
          CLOUDFLARE_TUNNEL_TOKEN=${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}
          N8N_DOMAIN=${{ vars.N8N_DOMAIN }}
          EOF
          
          # Hiá»ƒn thá»‹ thÃ´ng bÃ¡o thÃ nh cÃ´ng (khÃ´ng hiá»ƒn thá»‹ ná»™i dung cá»§a file vÃ¬ báº£o máº­t)
          echo "âœ… .env file created successfully"
          
          # Kiá»ƒm tra xem file Ä‘Ã£ tá»“n táº¡i chÆ°a
          if [ -f .env ]; then
            echo "âœ… .env file exists"
          else
            echo "âŒ Failed to create .env file"
            exit 1
          fi

      - name: Deploy n8n
        run: |
          echo "Deploying n8n..."
          
          # Thá»±c hiá»‡n pull vÃ  restart
          echo "Running docker-compose commands..."
          echo "Running docker-compose down:"
          docker-compose down
          echo "Down exit code: $?"
          echo "Running docker-compose pull:"
          docker-compose pull
          echo "Pull exit code: $?"
          echo "Running docker-compose up -d:"
          docker-compose -f docker-compose.yml -f docker-compose.override.yml up -d
          echo "Up exit code: $?"
          
      # Gá»­i thÃ´ng bÃ¡o Telegram (luÃ´n gá»­i dÃ¹ thÃ nh cÃ´ng hay tháº¥t báº¡i)
      - name: Send notification
        if: always()  # Thay Ä‘á»•i tá»« success() thÃ nh always() Ä‘á»ƒ luÃ´n gá»­i thÃ´ng bÃ¡o
        run: |
          if [[ ! -z "${{ secrets.TELEGRAM_BOT_TOKEN }}" && ! -z "${{ secrets.TELEGRAM_CHAT_ID }}" ]]; then
            # Táº¡o link Ä‘áº¿n GitHub Action run hiá»‡n táº¡i
            ACTION_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            
            # Kiá»ƒm tra tráº¡ng thÃ¡i cá»§a job
            if [ "${{ job.status }}" == "success" ]; then
              # ThÃ´ng bÃ¡o thÃ nh cÃ´ng
              STATUS_EMOJI="âœ…"
              STATUS_TEXT="Deployed n8n successfully!"
            else
              # ThÃ´ng bÃ¡o tháº¥t báº¡i
              STATUS_EMOJI="âŒ"
              STATUS_TEXT="Deployment n8n failed!"
            fi
            
            # Gá»­i thÃ´ng bÃ¡o tá»›i Telegram sá»­ dá»¥ng JSON Ä‘á»ƒ Ä‘áº£m báº£o xuá»‘ng dÃ²ng hoáº¡t Ä‘á»™ng chÃ­nh xÃ¡c
            curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
              -H "Content-Type: application/json" \
              -d '{
                "chat_id": "${{ secrets.TELEGRAM_CHAT_ID }}",
                "text": "'"$STATUS_EMOJI"' *'"$STATUS_TEXT"'*\n [View Deployment Details]('"$ACTION_URL"')",
                "parse_mode": "Markdown"
              }'
          fi