name: Auto Deploy n8n

on:
  push:
    branches: [ master, develop ]
  workflow_dispatch:
    # Cho phÃ©p kÃ­ch hoáº¡t thá»§ cÃ´ng

jobs:
  deploy:
    runs-on: self-hosted  # Chá»‰ Ä‘á»‹nh sá»­ dá»¥ng self-hosted runner thay vÃ¬ ubuntu-latest
    environment: production  # ThÃªm mÃ´i trÆ°á»ng production
    steps:
      - name: Clean runner temp env files
        run: |
          rm -f $RUNNER_WORKSPACE/_temp/*

      - name: Checkout code
        uses: actions/checkout@v3

      - name: Prepare n8n directories
        run: |
          # Táº¡o thÆ° má»¥c n8n_data vÃ  ssh náº¿u chÆ°a tá»“n táº¡i (khÃ´ng xÃ³a dá»¯ liá»‡u cÅ©)
          mkdir -p ./n8n_data
          mkdir -p ./ssh
          echo "âœ… ÄÃ£ chuáº©n bá»‹ thÆ° má»¥c, giá»¯ nguyÃªn dá»¯ liá»‡u n8n hiá»‡n cÃ³"

      - name: Create .env file from secrets
        run: |
          echo "Creating .env file..."
          
          # Táº¡o file .env tá»« GitHub Secrets vÃ  Variables cá»§a mÃ´i trÆ°á»ng
          cat > .env << EOF
          # Project name
          COMPOSE_PROJECT_NAME=${{ vars.COMPOSE_PROJECT_NAME || 'n8n' }}
          
          # PostgreSQL
          POSTGRES_USER=${{ secrets.POSTGRES_USER || 'n8n' }}
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB=${{ secrets.POSTGRES_DB || 'n8n_database' }}
          
          # n8n
          N8N_BASIC_AUTH_USER=${{ secrets.N8N_BASIC_AUTH_USER || 'admin' }}
          N8N_BASIC_AUTH_PASSWORD=${{ secrets.N8N_BASIC_AUTH_PASSWORD }}
          N8N_ENCRYPTION_KEY=${{ secrets.N8N_ENCRYPTION_KEY }}
          DB_POSTGRESDB_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          WEBHOOK_URL=${{ vars.WEBHOOK_URL }}
          
          # Timezone & other settings
          GENERIC_TIMEZONE=${{ secrets.GENERIC_TIMEZONE || 'Asia/Ho_Chi_Minh' }}
          TZ=${{ secrets.TZ || 'Asia/Ho_Chi_Minh' }}
          N8N_DEFAULT_BINARY_DATA_MODE=${{ secrets.N8N_DEFAULT_BINARY_DATA_MODE || 'filesystem' }}
          EXECUTIONS_DATA_PRUNE=${{ secrets.EXECUTIONS_DATA_PRUNE || 'true' }}
          EXECUTIONS_DATA_MAX_AGE=${{ secrets.EXECUTIONS_DATA_MAX_AGE || '720' }}
          EXECUTIONS_DATA_PRUNE_MAX_COUNT=${{ secrets.EXECUTIONS_DATA_PRUNE_MAX_COUNT || '50000' }}
          EOF
          
          # Hiá»ƒn thá»‹ thÃ´ng bÃ¡o thÃ nh cÃ´ng (khÃ´ng hiá»ƒn thá»‹ ná»™i dung cá»§a file vÃ¬ báº£o máº­t)
          echo "âœ… .env file created successfully"
          
          # Kiá»ƒm tra xem file Ä‘Ã£ tá»“n táº¡i chÆ°a
          if [ -f .env ]; then
            echo "âœ… .env file exists"
          else
            echo "âŒ Failed to create .env file"
            exit 1
          fi
          
      - name: Chuáº©n bá»‹ mÃ´i trÆ°á»ng vÃ  config n8n
        run: |
          echo "ðŸ§¹ Äang chuáº©n bá»‹ mÃ´i trÆ°á»ng..."
          # Táº¡o thÆ° má»¥c n8n_data náº¿u chÆ°a cÃ³
          if [ ! -d "./n8n_data" ]; then
            mkdir -p ./n8n_data
            echo "âœ… ÄÃ£ táº¡o thÆ° má»¥c n8n_data"
          fi
          # Sao lÆ°u file config náº¿u cÃ³
          if [ -f "./n8n_data/config" ]; then
            echo "ðŸ“¦ Sao lÆ°u file config hiá»‡n táº¡i..."
            cp "./n8n_data/config" "./n8n_data/config.bak"
            echo "âœ… ÄÃ£ sao lÆ°u file config"
          fi
          # Kiá»ƒm tra file config cÃ³ chÃº thÃ­ch khÃ´ng mong muá»‘n khÃ´ng
          CONFIG_ISSUE=false
          if [ -f "./n8n_data/config" ]; then
            if grep -q "# <<<=== THAY Báº°NG KHÃ“A Máº NH Cá»¦A Báº N" "./n8n_data/config"; then
              echo "âš ï¸ PhÃ¡t hiá»‡n chÃº thÃ­ch khÃ´ng mong muá»‘n trong file config hiá»‡n táº¡i"
              CONFIG_ISSUE=true
            fi
          fi
          # Chá»‰ táº¡o file config má»›i náº¿u khÃ´ng tá»“n táº¡i hoáº·c cÃ³ váº¥n Ä‘á»
          if [ ! -f "./n8n_data/config" ] || [ "$CONFIG_ISSUE" = true ]; then
            if [ -f ".env" ]; then
              CLEAN_KEY=$(grep "N8N_ENCRYPTION_KEY" .env | cut -d '=' -f2 | xargs)
              if [ ! -z "$CLEAN_KEY" ]; then
                echo "ðŸ“ Táº¡o file config vá»›i encryptionKey tá»« .env..."
                echo "{\"encryptionKey\": \"$CLEAN_KEY\"}" > ./n8n_data/config
                echo "âœ… ÄÃ£ táº¡o file config má»›i"
              else
                echo "âš ï¸ KhÃ´ng tÃ¬m tháº¥y N8N_ENCRYPTION_KEY trong file .env"
              fi
            else
              echo "âš ï¸ KhÃ´ng tÃ¬m tháº¥y file .env"
            fi
          else
            echo "âœ… File config hiá»‡n táº¡i khÃ´ng cÃ³ váº¥n Ä‘á», giá»¯ nguyÃªn"
          fi

      - name: Pull vÃ  build docker images
        run: |
          echo "ðŸ”„ Äang pull images má»›i nháº¥t..."
          docker-compose pull
          echo "âœ… ÄÃ£ pull images thÃ nh cÃ´ng"
          echo "ðŸ”¨ Äang build images cho táº¥t cáº£ cÃ¡c dá»‹ch vá»¥..."
          docker-compose build
          echo "âœ… ÄÃ£ build images thÃ nh cÃ´ng"

      - name: Dá»«ng vÃ  xÃ³a container cÅ© (náº¿u cÃ³)
        run: |
          echo "â¹ï¸ Dá»«ng containers hiá»‡n táº¡i..."
          docker-compose down || true
          # XÃ³a container pfm_excel_api náº¿u cÃ²n tá»“n táº¡i
          if docker ps -a --format '{{.Names}}' | grep -q '^pfm_excel_api$'; then
            echo "âš ï¸ Äang xÃ³a container pfm_excel_api cÅ©..."
            docker rm -f pfm_excel_api
            echo "âœ… ÄÃ£ xÃ³a container pfm_excel_api cÅ©"
          fi
          echo "âœ… ÄÃ£ dá»«ng cÃ¡c containers hiá»‡n táº¡i"

      - name: Khá»Ÿi Ä‘á»™ng láº¡i n8n
        run: |
          docker-compose -f docker-compose.yml up -d
          echo "âœ… ÄÃ£ khá»Ÿi Ä‘á»™ng containers thÃ nh cÃ´ng"
          echo "â³ Äang Ä‘á»£i n8n khá»Ÿi Ä‘á»™ng..."
          sleep 15

      - name: Kiá»ƒm tra tráº¡ng thÃ¡i container n8n_main
        run: |
          if ! docker ps | grep -q "n8n_main"; then
            echo "âš ï¸ Container n8n_main khÃ´ng Ä‘ang cháº¡y, kiá»ƒm tra logs..."
            docker logs n8n_main --tail 50
            exit 1
          fi
          echo "âœ… Container n8n_main Ä‘ang cháº¡y"

      - name: Kiá»ƒm tra vÃ  sá»­a file config trong container náº¿u cáº§n
        run: |
          CONFIG_CONTENT=$(docker exec n8n_main cat /home/node/.n8n/config 2>/dev/null || echo "")
          if echo "$CONFIG_CONTENT" | grep -q "# <<<=== THAY Báº°NG KHÃ“A Máº NH Cá»¦A Báº N"; then
            echo "âš ï¸ TÃ¬m tháº¥y chÃº thÃ­ch khÃ´ng mong muá»‘n trong file config"
            CLEAN_KEY=$(grep "N8N_ENCRYPTION_KEY" .env | cut -d '=' -f2 | xargs)
            if [ -z "$CLEAN_KEY" ]; then
              echo "KhÃ´ng tÃ¬m tháº¥y giÃ¡ trá»‹ N8N_ENCRYPTION_KEY trong file .env"
              exit 1
            fi
            echo "{\"encryptionKey\": \"$CLEAN_KEY\"}" > ./n8n_data/config.new
            docker cp ./n8n_data/config.new n8n_main:/home/node/.n8n/config
            docker restart n8n_main
            sleep 30
            NEW_CONFIG_CONTENT=$(docker exec n8n_main cat /home/node/.n8n/config 2>/dev/null || echo "")
            if echo "$NEW_CONFIG_CONTENT" | grep -q "# <<<=== THAY Báº°NG KHÃ“A Máº NH Cá»¦A Báº N"; then
              echo "Váº«n cÃ²n chÃº thÃ­ch khÃ´ng mong muá»‘n trong file config sau khi sá»­a"
              exit 1
            else
              echo "âœ… ÄÃ£ sá»­a file config thÃ nh cÃ´ng"
            fi
          else
            echo "âœ… KhÃ´ng tÃ¬m tháº¥y chÃº thÃ­ch khÃ´ng mong muá»‘n trong file config"
          fi

      - name: Kiá»ƒm tra thÆ° viá»‡n msoffcrypto-tool trong container
        run: |
          if docker exec n8n_main bash -c "pip3 list | grep -q msoffcrypto-tool"; then
            MSOFFCRYPTO_VERSION=$(docker exec n8n_main bash -c "pip3 list | grep msoffcrypto-tool" | awk '{print $2}')
            echo "âœ… ThÆ° viá»‡n msoffcrypto-tool Ä‘Ã£ Ä‘Æ°á»£c cÃ i Ä‘áº·t (phiÃªn báº£n $MSOFFCRYPTO_VERSION)"
          else
            echo "âš ï¸ ThÆ° viá»‡n msoffcrypto-tool chÆ°a Ä‘Æ°á»£c cÃ i Ä‘áº·t Ä‘Ãºng cÃ¡ch"
          fi

      - name: Kiá»ƒm tra tráº¡ng thÃ¡i cÃ¡c container
        run: |
          docker-compose ps

      - name: Hiá»ƒn thá»‹ URL truy cáº­p n8n
        run: |
          echo "ðŸŒ n8n Ä‘Ã£ Ä‘Æ°á»£c triá»ƒn khai thÃ nh cÃ´ng vÃ  cÃ³ thá»ƒ truy cáº­p táº¡i:"
          echo "   http://localhost:5678"
          if [ ! -z "$WEBHOOK_URL" ]; then
            echo "   hoáº·c: $WEBHOOK_URL"
          fi
          echo "âœ… TRIá»‚N KHAI N8N HOÃ€N Táº¤T THÃ€NH CÃ”NG"

      # Gá»­i thÃ´ng bÃ¡o Telegram (luÃ´n gá»­i dÃ¹ thÃ nh cÃ´ng hay tháº¥t báº¡i)
      - name: Send notification
        if: always()  # Thay Ä‘á»•i tá»« success() thÃ nh always() Ä‘á»ƒ luÃ´n gá»­i thÃ´ng bÃ¡o
        run: |
          if [[ ! -z "${{ secrets.TELEGRAM_BOT_TOKEN }}" && ! -z "${{ secrets.TELEGRAM_CHAT_ID }}" ]]; then
            # Táº¡o link Ä‘áº¿n GitHub Action run hiá»‡n táº¡i
            ACTION_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            
            # Kiá»ƒm tra tráº¡ng thÃ¡i cá»§a job
            if [ "${{ job.status }}" == "success" ]; then
              # ThÃ´ng bÃ¡o thÃ nh cÃ´ng
              STATUS_EMOJI="âœ…"
              STATUS_TEXT="Deployed n8n successfully!"
            else
              # ThÃ´ng bÃ¡o tháº¥t báº¡i
              STATUS_EMOJI="âŒ"
              STATUS_TEXT="Deployment n8n failed!"
            fi
            
            # Gá»­i thÃ´ng bÃ¡o tá»›i Telegram sá»­ dá»¥ng JSON Ä‘á»ƒ Ä‘áº£m báº£o xuá»‘ng dÃ²ng hoáº¡t Ä‘á»™ng chÃ­nh xÃ¡c
            curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
              -H "Content-Type: application/json" \
              -d '{
                "chat_id": "${{ secrets.TELEGRAM_CHAT_ID }}",
                "text": "'"$STATUS_EMOJI"' *'"$STATUS_TEXT"'*\n [View Deployment Details]('"$ACTION_URL"')",
                "parse_mode": "Markdown"
              }'
          fi