name: Daily n8n Backup (Production Only)

on:
  workflow_dispatch:
    # Cho ph√©p k√≠ch ho·∫°t th·ªß c√¥ng
  schedule:
    - cron: '15 0 * * *' # 7h15 s√°ng gi·ªù Vi·ªát Nam (UTC+7)

jobs:
  backup:
    if: ${{ github.ref_name == 'master' }}
    runs-on: ubuntu-latest # Changed from self-hosted
    environment: production # Explicitly set environment for master branch
    # ƒê·∫∑t th·ªùi gian timeout cho to√†n b·ªô job n√†y l√† 30 ph√∫t
    timeout-minutes: 30 
    name: Daily n8n Backup (Production via TrueNAS SSH) # Updated name for clarity
    steps:
      - name: Set TrueNAS Deploy Directory Environment Variable
        run: echo "TRUENAS_DEPLOY_DIR=${{ vars.DEPLOY_PATH_ON_TRUENAS }}/deploy_${{ github.ref_name }}" >> $GITHUB_ENV
        shell: bash

      - name: Setup Cloudflared and SSH Config
        run: |
          echo "Runner HOME directory is: $HOME"
          # C√†i ƒë·∫∑t cloudflared
          sudo wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -O /usr/local/bin/cloudflared
          sudo chmod +x /usr/local/bin/cloudflared
          echo "Cloudflared version: $(cloudflared --version)"

          # T·∫°o th∆∞ m·ª•c $HOME/.ssh n·∫øu ch∆∞a t·ªìn t·∫°i
          mkdir -p "$HOME/.ssh"
          
          # T·∫°o t·ªáp c·∫•u h√¨nh SSH s·ª≠ d·ª•ng $HOME v·ªõi keep-alive settings
          echo "Host truenas-cf-tunnel
            HostName ${{ secrets.TRUENAS_SSH_HOSTNAME_THROUGH_CLOUDFLARED }}
            ProxyCommand cloudflared access ssh --hostname %h
            User ${{ secrets.TRUENAS_USER }}
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
            LogLevel ERROR
            ServerAliveInterval 60
            ServerAliveCountMax 10
            TCPKeepAlive yes" > "$HOME/.ssh/config" # S·ª≠ d·ª•ng $HOME
          
          chmod 600 "$HOME/.ssh/config"
          echo "‚úÖ SSH config for Cloudflared created at $HOME/.ssh/config"
        shell: bash

      - name: Add TrueNAS SSH Private Key to SSH Agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.TRUENAS_SSH_PRIVATE_KEY }}

      - name: Check required files on TrueNAS
        run: |
          ssh -F "$HOME/.ssh/config" truenas-cf-tunnel << EOF
            set -e # Exit immediately if a command exits with a non-zero status.
            echo "Checking files in ${{ env.TRUENAS_DEPLOY_DIR }} on TrueNAS..."
            cd "${{ env.TRUENAS_DEPLOY_DIR }}"
            if [ ! -f .env ]; then
              echo "‚ùå Kh√¥ng t√¨m th·∫•y file .env trong ${{ env.TRUENAS_DEPLOY_DIR }} tr√™n TrueNAS"; exit 1;
            fi
            if [ ! -f backup-n8n.sh ]; then
              echo "‚ùå Kh√¥ng t√¨m th·∫•y script backup-n8n.sh trong ${{ env.TRUENAS_DEPLOY_DIR }} tr√™n TrueNAS"; exit 1;
            fi
            echo "‚úÖ Required files .env and backup-n8n.sh found on TrueNAS."
          EOF
        shell: bash

      - name: Execute backup on TrueNAS
        run: |
          ssh -F "$HOME/.ssh/config" truenas-cf-tunnel << EOF
            set -e # Exit immediately if a command exits with a non-zero status.
            echo "üîí ƒêang backup d·ªØ li·ªáu n8n cho m√¥i tr∆∞·ªùng production (branch: ${{ github.ref_name }}) tr√™n TrueNAS..."
            echo "   Th∆∞ m·ª•c tri·ªÉn khai: ${{ env.TRUENAS_DEPLOY_DIR }}"
            cd "${{ env.TRUENAS_DEPLOY_DIR }}"
            bash ./backup-n8n.sh
            echo "‚úÖ ƒê√£ backup d·ªØ li·ªáu n8n th√†nh c√¥ng tr√™n TrueNAS."
          EOF
        shell: bash

      - name: Set backup error timestamp
        if: failure()
        run: |
          echo "TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_ENV

      - name: Send Discord error notification for backup
        if: failure()
        uses: appleboy/discord-action@v1.2.0
        with:
          webhook_url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          message: |
            ‚ùå Backup n8n th·∫•t b·∫°i tr√™n branch **${{ github.ref_name }}** l√∫c **${{ env.TIMESTAMP }}**
            Nh√°nh: **${{ github.ref_name }}**
            [Xem Chi Ti·∫øt Job](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

      - name: Send Discord timeout notification for backup
        if: cancelled()
        uses: appleboy/discord-action@v1.2.0
        with:
          webhook_url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          message: |
            ‚è±Ô∏è Backup n8n (Production) **ƒê√É B·ªä H·ª¶Y** do qu√° th·ªùi gian (timeout > 30 ph√∫t)!
            Nh√°nh: **${{ github.ref_name }}**
            [Xem Chi Ti·∫øt Job](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

