name: Daily n8n Backup (Production Only)

on:
  workflow_dispatch:
    # Cho phÃ©p kÃ­ch hoáº¡t thá»§ cÃ´ng
  schedule:
    - cron: '15 0 * * *' # 7h15 sÃ¡ng giá» Viá»‡t Nam (UTC+7)

jobs:
  backup:
    if: ${{ github.ref_name == 'master' }}
    runs-on: ubuntu-latest # Changed from self-hosted
    environment: production # Explicitly set environment for master branch
    # Äáº·t thá»i gian timeout cho toÃ n bá»™ job nÃ y lÃ  30 phÃºt
    timeout-minutes: 30 
    name: Daily n8n Backup (Production via TrueNAS SSH) # Updated name for clarity
    steps:
      - name: Set TrueNAS Deploy Directory Environment Variable
        run: echo "TRUENAS_DEPLOY_DIR=${{ vars.DEPLOY_PATH_ON_TRUENAS }}/deploy_${{ github.ref_name }}" >> $GITHUB_ENV
        shell: bash

      - name: Setup Cloudflared and SSH Config
        run: |
          echo "Runner HOME directory is: $HOME"
          # CÃ i Ä‘áº·t cloudflared
          sudo wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -O /usr/local/bin/cloudflared
          sudo chmod +x /usr/local/bin/cloudflared
          echo "Cloudflared version: $(cloudflared --version)"

          # Táº¡o thÆ° má»¥c $HOME/.ssh náº¿u chÆ°a tá»“n táº¡i
          mkdir -p "$HOME/.ssh"
          
          # Táº¡o tá»‡p cáº¥u hÃ¬nh SSH sá»­ dá»¥ng $HOME
          echo "Host truenas-cf-tunnel
            HostName ${{ secrets.TRUENAS_SSH_HOSTNAME_THROUGH_CLOUDFLARED }}
            ProxyCommand cloudflared access ssh --hostname %h
            User ${{ secrets.TRUENAS_USER }}
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
            LogLevel ERROR" > "$HOME/.ssh/config" # Sá»­ dá»¥ng $HOME
          
          chmod 600 "$HOME/.ssh/config"
          echo "âœ… SSH config for Cloudflared created at $HOME/.ssh/config"
        shell: bash

      - name: Add TrueNAS SSH Private Key to SSH Agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.TRUENAS_SSH_PRIVATE_KEY }}

      - name: Check required files on TrueNAS
        run: |
          ssh -F "$HOME/.ssh/config" truenas-cf-tunnel << EOF
            set -e # Exit immediately if a command exits with a non-zero status.
            echo "Checking files in ${{ env.TRUENAS_DEPLOY_DIR }} on TrueNAS..."
            cd "${{ env.TRUENAS_DEPLOY_DIR }}"
            if [ ! -f .env ]; then
              echo "âŒ KhÃ´ng tÃ¬m tháº¥y file .env trong ${{ env.TRUENAS_DEPLOY_DIR }} trÃªn TrueNAS"; exit 1;
            fi
            if [ ! -f backup-n8n.sh ]; then
              echo "âŒ KhÃ´ng tÃ¬m tháº¥y script backup-n8n.sh trong ${{ env.TRUENAS_DEPLOY_DIR }} trÃªn TrueNAS"; exit 1;
            fi
            echo "âœ… Required files .env and backup-n8n.sh found on TrueNAS."
          EOF
        shell: bash

      - name: Execute backup on TrueNAS
        run: |
          ssh -F "$HOME/.ssh/config" truenas-cf-tunnel << EOF
            set -e # Exit immediately if a command exits with a non-zero status.
            echo "ðŸ”’ Äang backup dá»¯ liá»‡u n8n cho mÃ´i trÆ°á»ng production (branch: ${{ github.ref_name }}) trÃªn TrueNAS..."
            echo "   ThÆ° má»¥c triá»ƒn khai: ${{ env.TRUENAS_DEPLOY_DIR }}"
            cd "${{ env.TRUENAS_DEPLOY_DIR }}"
            bash ./backup-n8n.sh
            echo "âœ… ÄÃ£ backup dá»¯ liá»‡u n8n thÃ nh cÃ´ng trÃªn TrueNAS."
          EOF
        shell: bash

      - name: Gá»­i thÃ´ng bÃ¡o lá»—i backup lÃªn Telegram
        if: failure()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          MESSAGE="âŒ Backup n8n tháº¥t báº¡i trÃªn branch $GITHUB_REF_NAME lÃºc $(date '+%Y-%m-%d %H:%M:%S')"
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d text="$MESSAGE" 