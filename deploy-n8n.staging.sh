#!/bin/bash
# deploy-n8n.staging.sh - Script tri·ªÉn khai n8n cho m√¥i tr∆∞·ªùng staging

# Hi·ªÉn th·ªã banner
echo "=============================================="
echo "      TRI·ªÇN KHAI N8N SERVER - STAGING        "
echo "=============================================="

# Ghi log v·ªõi timestamp
log() {
  echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1"
}

# X·ª≠ l√Ω l·ªói
handle_error() {
  log "‚ùå L·ªói: $1"
  exit 1
}

# 1. Ki·ªÉm tra file .env
log "üîç Ki·ªÉm tra file .env..."
if [ ! -f ".env" ]; then
  handle_error "Kh√¥ng t√¨m th·∫•y file .env"
fi

# 2. Chu·∫©n b·ªã m√¥i tr∆∞·ªùng
log "üßπ ƒêang chu·∫©n b·ªã m√¥i tr∆∞·ªùng..."

# T·∫°o th∆∞ m·ª•c n8n_data_staging tr∆∞·ªõc n·∫øu ch∆∞a t·ªìn t·∫°i
if [ ! -d "./n8n_data_staging" ]; then
  mkdir -p ./n8n_data_staging
  log "‚úÖ ƒê√£ t·∫°o th∆∞ m·ª•c n8n_data_staging"
fi

# Sao l∆∞u file config hi·ªán t·∫°i n·∫øu c√≥
if [ -f "./n8n_data_staging/config" ]; then
  log "üì¶ Sao l∆∞u file config hi·ªán t·∫°i..."
  cp "./n8n_data_staging/config" "./n8n_data_staging/config.bak"
  log "‚úÖ ƒê√£ sao l∆∞u file config"
fi

# Ki·ªÉm tra file config hi·ªán t·∫°i xem c√≥ ch·ª©a ch√∫ th√≠ch kh√¥ng mong mu·ªën kh√¥ng
CONFIG_ISSUE=false
if [ -f "./n8n_data_staging/config" ]; then
  if grep -q "# <<<=== THAY B·∫∞NG KH√ìA M·∫†NH C·ª¶A B·∫†N" "./n8n_data_staging/config"; then
    log "‚ö†Ô∏è Ph√°t hi·ªán ch√∫ th√≠ch kh√¥ng mong mu·ªën trong file config hi·ªán t·∫°i"
    CONFIG_ISSUE=true
  fi
fi

# CH·ªà t·∫°o file config m·ªõi n·∫øu kh√¥ng t·ªìn t·∫°i ho·∫∑c c√≥ v·∫•n ƒë·ªÅ
if [ ! -f "./n8n_data_staging/config" ] || [ "$CONFIG_ISSUE" = true ]; then
  if [ -f ".env" ]; then
    CLEAN_KEY=$(grep "N8N_ENCRYPTION_KEY" .env | cut -d '=' -f2 | xargs)
    if [ ! -z "$CLEAN_KEY" ]; then
      log "üìù T·∫°o file config v·ªõi encryptionKey t·ª´ .env..."
      echo "{\"encryptionKey\": \"$CLEAN_KEY\"}" > ./n8n_data_staging/config
      log "‚úÖ ƒê√£ t·∫°o file config m·ªõi"
    else
      log "‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y N8N_ENCRYPTION_KEY trong file .env"
    fi
  else
    log "‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y file .env"
  fi
else
  log "‚úÖ File config hi·ªán t·∫°i kh√¥ng c√≥ v·∫•n ƒë·ªÅ, gi·ªØ nguy√™n"
fi

# 3. Build Excel API image
log "üî® ƒêang build Excel API image..."
cd src/ExcelApi
docker build -t pfm-excel-api:latest . || handle_error "Kh√¥ng th·ªÉ build Excel API image"
cd ../..
log "‚úÖ ƒê√£ build Excel API image th√†nh c√¥ng"

# 4. Pull PostgreSQL image
log "üì• ƒêang pull PostgreSQL image..."
docker pull postgres:15 || handle_error "Kh√¥ng th·ªÉ pull PostgreSQL image"
log "‚úÖ ƒê√£ pull PostgreSQL image th√†nh c√¥ng"

# 5. D·ª´ng container hi·ªán t·∫°i (n·∫øu c√≥)
log "‚èπÔ∏è D·ª´ng containers hi·ªán t·∫°i..."
docker-compose -f docker-compose.yml -f docker-compose.staging.yml down || true
log "‚úÖ ƒê√£ d·ª´ng c√°c containers hi·ªán t·∫°i"

# 6. GI·ªÆ NGUY√äN VOLUMES - Kh√¥ng x√≥a volumes n·ªØa
log "‚úÖ Gi·ªØ nguy√™n d·ªØ li·ªáu n8n hi·ªán c√≥"

# 7. Kh·ªüi ƒë·ªông container
log "üöÄ ƒêang kh·ªüi ƒë·ªông containers..."
docker-compose -f docker-compose.yml -f docker-compose.staging.yml up -d || handle_error "Kh√¥ng th·ªÉ kh·ªüi ƒë·ªông containers"
log "‚úÖ ƒê√£ kh·ªüi ƒë·ªông containers th√†nh c√¥ng"

# 8. ƒê·ª£i n8n kh·ªüi ƒë·ªông
log "‚è≥ ƒêang ƒë·ª£i n8n kh·ªüi ƒë·ªông..."
sleep 15
log "‚úÖ ƒê√£ ƒë·ª£i ƒë·ªß th·ªùi gian cho n8n kh·ªüi ƒë·ªông"

# 9. Ki·ªÉm tra tr·∫°ng th√°i container
log "üîç Ki·ªÉm tra tr·∫°ng th√°i container n8n..."
if ! docker ps | grep -q "n8n_main_staging"; then
  log "‚ö†Ô∏è Container n8n_main_staging kh√¥ng ƒëang ch·∫°y, ki·ªÉm tra logs..."
  docker logs n8n_main_staging --tail 50
  handle_error "Container n8n_main_staging kh√¥ng kh·ªüi ƒë·ªông ƒë∆∞·ª£c"
fi
log "‚úÖ Container n8n_main_staging ƒëang ch·∫°y"

# 10. Ki·ªÉm tra file config
log "üîç Ki·ªÉm tra file config c·ªßa n8n..."
CONFIG_CONTENT=$(docker exec n8n_main_staging cat /home/node/.n8n/config 2>/dev/null)
if [ $? -ne 0 ]; then
  log "‚ö†Ô∏è Kh√¥ng th·ªÉ ƒë·ªçc file config, c√≥ th·ªÉ file ch∆∞a ƒë∆∞·ª£c t·∫°o"
else
  echo "$CONFIG_CONTENT"
  log "‚úÖ ƒê√£ ƒë·ªçc file config th√†nh c√¥ng"
fi

# 11. Ki·ªÉm tra th∆∞ vi·ªán msoffcrypto-tool
log "üîç Ki·ªÉm tra c√†i ƒë·∫∑t th∆∞ vi·ªán msoffcrypto-tool..."
if docker exec n8n_main_staging bash -c "pip3 list | grep -q msoffcrypto-tool"; then
  MSOFFCRYPTO_VERSION=$(docker exec n8n_main_staging bash -c "pip3 list | grep msoffcrypto-tool" | awk '{print $2}')
  log "‚úÖ Th∆∞ vi·ªán msoffcrypto-tool ƒë√£ ƒë∆∞·ª£c c√†i ƒë·∫∑t (phi√™n b·∫£n $MSOFFCRYPTO_VERSION)"
else
  log "‚ö†Ô∏è Th∆∞ vi·ªán msoffcrypto-tool ch∆∞a ƒë∆∞·ª£c c√†i ƒë·∫∑t ƒë√∫ng c√°ch"
fi

# 12. Ki·ªÉm tra tr·∫°ng th√°i c√°c container
log "üîç Ki·ªÉm tra tr·∫°ng th√°i c√°c container..."
docker-compose -f docker-compose.yml -f docker-compose.staging.yml ps

# 13. Hi·ªÉn th·ªã URL truy c·∫≠p n8n
log "üåê n8n ƒë√£ ƒë∆∞·ª£c tri·ªÉn khai th√†nh c√¥ng v√† c√≥ th·ªÉ truy c·∫≠p t·∫°i:"
echo "   http://localhost:5679"
if [ ! -z "$WEBHOOK_URL" ]; then
  echo "   ho·∫∑c: $WEBHOOK_URL"
fi

log "‚úÖ TRI·ªÇN KHAI N8N STAGING HO√ÄN T·∫§T TH√ÄNH C√îNG"
exit 0 